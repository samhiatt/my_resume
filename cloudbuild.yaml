steps:
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: [ '-c', 'docker pull gcr.io/$PROJECT_ID/my_resume:latest']
#                    && docker tag gcr.io/$PROJECT_ID/my_resume:latest my_resume:local' ]

  - name: 'gcr.io/cloud-builders/docker'
    args: [
        'build',
        '--file', 'Dockerfile',
        '-t', 'gcr.io/$PROJECT_ID/my_resume:latest',
#        '-t', 'gcr.io/$PROJECT_ID/my_resume:$COMMIT_SHA',
        '--cache-from', 'gcr.io/$PROJECT_ID/my_resume:latest',
        '.' ]
        
  - name: 'gcr.io/cloud-builders/docker'
    volumes:
    - name: 'vol1'
      path: '/output'
##    args: [ "run", "--rm", "-v", "vol1:/output", "gcr.io/$PROJECT_ID/output:latest"]
#    args: [ "run", "--rm", "-v", "vol1:/output", "output"]
    args: [ 'run', '--name', 'pandoc_container', 'gcr.io/$PROJECT_ID/my_resume:latest']
    
#  - name: 'gcr.io/cloud-builders/docker',
#    args: ['cp', 'pandoc_container:/output/resume.pdf', './resume.pdf']

 
# Access the id_github file from Secret Manager, and setup SSH
  - name: 'gcr.io/cloud-builders/git'
    secretEnv: ['SSH_KEY']
    entrypoint: 'bash'
    args:
    - -c
    - |
      echo "$$SSH_KEY" >> /root/.ssh/id_rsa
      chmod 400 /root/.ssh/id_rsa
      cp known_hosts.github /root/.ssh/known_hosts
    volumes:
    - name: 'ssh'
      path: /root/.ssh

# Clone the repository
  - name: 'gcr.io/cloud-builders/git'
    args:
    - clone
    - --recurse-submodules
    - git@github.com:samhiatt/my_resume
    volumes:
    - name: 'ssh'
      path: /root/.ssh
      
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'ls -la /output']
    volumes:
    - name: 'ssh'
      path: /root/.ssh
    - name: 'vol1'
      path: '/output' 

availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/gh_samhiatt_my_resume_priv/versions/latest
    env: 'SSH_KEY'


images:
#  - 'gcr.io/$PROJECT_ID/my_resume:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/my_resume:latest'

#artifacts:
#  objects:  
#    location: 'gs://samhiatt-resume-artifacts/$COMMIT_SHA/'
#    paths: ['/output/*']